{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ahmed/Desktop/Fifth%20semester/blockchain/project/frontend/app/lib/db.js"],"sourcesContent":["import mysql from \"mysql2/promise\";\r\n\r\nlet pool;\r\n\r\nfunction createPool() {\r\n  const parsedPort = process.env.DB_PORT ? Number(process.env.DB_PORT) : 3306;\r\n\r\n  return mysql.createPool({\r\n    host: process.env.DB_HOST,\r\n    user: process.env.DB_USER,\r\n    password: process.env.DB_PASSWORD,\r\n    database: process.env.DB_NAME || \"academic_system\",\r\n    waitForConnections: true,\r\n    port: Number.isNaN(parsedPort) ? 3306 : parsedPort,\r\n    connectionLimit: 10,\r\n    queueLimit: 0,\r\n  });\r\n}\r\n\r\nexport async function getPool() {\r\n  try {\r\n    if (!pool) {\r\n      pool = createPool();\r\n    }\r\n\r\n    // Lightweight health-check to fail fast if DB credentials are invalid.\r\n    await pool.query(\"SELECT 1\");\r\n    return pool;\r\n  } catch (error) {\r\n    console.error(\"Database connection error:\", error);\r\n    throw new Error(\"Failed to connect to MySQL\");\r\n  }\r\n}\r\n\r\nexport async function executeQuery(sql, params = []) {\r\n  try {\r\n    const db = await getPool();\r\n    const [result] = await db.execute(sql, params);\r\n    return result;\r\n  } catch (error) {\r\n    console.error(\"Database query error:\", error);\r\n    throw new Error(\"Database query failed\");\r\n  }\r\n}\r\n\r\nexport { pool };\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,IAAI;AAEJ,SAAS;IACP,MAAM,aAAa,QAAQ,GAAG,CAAC,OAAO,GAAG,OAAO,QAAQ,GAAG,CAAC,OAAO,IAAI;IAEvE,OAAO,iNAAK,CAAC,UAAU,CAAC;QACtB,MAAM,QAAQ,GAAG,CAAC,OAAO;QACzB,MAAM,QAAQ,GAAG,CAAC,OAAO;QACzB,UAAU,QAAQ,GAAG,CAAC,WAAW;QACjC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;QACjC,oBAAoB;QACpB,MAAM,OAAO,KAAK,CAAC,cAAc,OAAO;QACxC,iBAAiB;QACjB,YAAY;IACd;AACF;AAEO,eAAe;IACpB,IAAI;QACF,IAAI,CAAC,MAAM;YACT,OAAO;QACT;QAEA,uEAAuE;QACvE,MAAM,KAAK,KAAK,CAAC;QACjB,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,MAAM,IAAI,MAAM;IAClB;AACF;AAEO,eAAe,aAAa,GAAG,EAAE,SAAS,EAAE;IACjD,IAAI;QACF,MAAM,KAAK,MAAM;QACjB,MAAM,CAAC,OAAO,GAAG,MAAM,GAAG,OAAO,CAAC,KAAK;QACvC,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM,IAAI,MAAM;IAClB;AACF"}},
    {"offset": {"line": 193, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/Desktop/Fifth semester/blockchain/project/frontend/app/abi.json"],"sourcesContent":["[{\"inputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"string\",\"name\":\"studentId\",\"type\":\"string\"},{\"indexed\":false,\"internalType\":\"string\",\"name\":\"documentHash\",\"type\":\"string\"}],\"name\":\"RecordIssued\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"string\",\"name\":\"studentId\",\"type\":\"string\"}],\"name\":\"RecordRevoked\",\"type\":\"event\"},{\"inputs\":[],\"name\":\"admin\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"string\",\"name\":\"_studentId\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"_documentHash\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"_issuer\",\"type\":\"string\"}],\"name\":\"issueRecord\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"string\",\"name\":\"_studentId\",\"type\":\"string\"}],\"name\":\"revokeRecord\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"string\",\"name\":\"_studentId\",\"type\":\"string\"}],\"name\":\"verifyRecord\",\"outputs\":[{\"components\":[{\"internalType\":\"string\",\"name\":\"studentId\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"documentHash\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"issuer\",\"type\":\"string\"},{\"internalType\":\"uint256\",\"name\":\"timestamp\",\"type\":\"uint256\"},{\"internalType\":\"bool\",\"name\":\"isValid\",\"type\":\"bool\"}],\"internalType\":\"struct AcademicRecords.Record\",\"name\":\"\",\"type\":\"tuple\"}],\"stateMutability\":\"view\",\"type\":\"function\"}]"],"names":[],"mappings":"AAAA"}},
    {"offset": {"line": 193, "column": 1585}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}},
    {"offset": {"line": 197, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ahmed/Desktop/Fifth%20semester/blockchain/project/frontend/app/lib/blockchain.js"],"sourcesContent":["import { ethers } from \"ethers\";\r\nimport ABI from \"../abi.json\";\r\n\r\nfunction validateEnv() {\r\n  const required = [\"PRIVATE_KEY\", \"CONTRACT_ADDRESS\"];\r\n  const missing = required.filter((key) => !process.env[key]);\r\n\r\n  if (missing.length > 0) {\r\n    throw new Error(`Missing required environment variables: ${missing.join(\", \")}`);\r\n  }\r\n}\r\n\r\nvalidateEnv();\r\n\r\n// Provider = read/write connection to the Ethereum JSON-RPC node.\r\n// It talks to Hardhat local chain at http://127.0.0.1:8545.\r\nconst provider = new ethers.JsonRpcProvider(process.env.RPC_URL || \"http://127.0.0.1:8545\");\r\n\r\n// Wallet = backend signing identity. Every state-changing tx is signed with\r\n// this private key before being broadcast. The key must stay server-side only.\r\nconst wallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider);\r\n\r\n// Contract instance bound to the signing wallet.\r\n// Digital signature flow:\r\n// 1) API route calls a write method (e.g., issueRecord).\r\n// 2) ethers prepares transaction data.\r\n// 3) wallet signs tx with PRIVATE_KEY.\r\n// 4) signed tx is sent to chain and validated by nodes.\r\nconst contract = new ethers.Contract(process.env.CONTRACT_ADDRESS, ABI, wallet);\r\n\r\nlet contractCodeValidated = false;\r\n\r\nexport async function ensureContractIsDeployed() {\r\n  if (contractCodeValidated) {\r\n    return;\r\n  }\r\n\r\n  const code = await provider.getCode(process.env.CONTRACT_ADDRESS);\r\n  if (!code || code === \"0x\") {\r\n    throw new Error(\r\n      \"Invalid CONTRACT_ADDRESS: no contract bytecode found. Set CONTRACT_ADDRESS to the deployed AcademicRecords contract address.\"\r\n    );\r\n  }\r\n\r\n  contractCodeValidated = true;\r\n}\r\n\r\nexport { provider, wallet, contract };\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;;;AAEA,SAAS;IACP,MAAM,WAAW;QAAC;QAAe;KAAmB;IACpD,MAAM,UAAU,SAAS,MAAM,CAAC,CAAC,MAAQ,CAAC,QAAQ,GAAG,CAAC,IAAI;IAE1D,IAAI,QAAQ,MAAM,GAAG,GAAG;QACtB,MAAM,IAAI,MAAM,CAAC,wCAAwC,EAAE,QAAQ,IAAI,CAAC,OAAO;IACjF;AACF;AAEA;AAEA,kEAAkE;AAClE,4DAA4D;AAC5D,MAAM,WAAW,IAAI,+PAAM,CAAC,eAAe,CAAC,QAAQ,GAAG,CAAC,OAAO,IAAI;AAEnE,4EAA4E;AAC5E,+EAA+E;AAC/E,MAAM,SAAS,IAAI,+PAAM,CAAC,MAAM,CAAC,QAAQ,GAAG,CAAC,WAAW,EAAE;AAE1D,iDAAiD;AACjD,0BAA0B;AAC1B,yDAAyD;AACzD,uCAAuC;AACvC,uCAAuC;AACvC,wDAAwD;AACxD,MAAM,WAAW,IAAI,+PAAM,CAAC,QAAQ,CAAC,QAAQ,GAAG,CAAC,gBAAgB,EAAE,gKAAG,EAAE;AAExE,IAAI,wBAAwB;AAErB,eAAe;IACpB,IAAI,uBAAuB;QACzB;IACF;IAEA,MAAM,OAAO,MAAM,SAAS,OAAO,CAAC,QAAQ,GAAG,CAAC,gBAAgB;IAChE,IAAI,CAAC,QAAQ,SAAS,MAAM;QAC1B,MAAM,IAAI,MACR;IAEJ;IAEA,wBAAwB;AAC1B"}},
    {"offset": {"line": 251, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ahmed/Desktop/Fifth%20semester/blockchain/project/frontend/app/api/admin/revoke/route.js"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { getPool } from \"../../../lib/db\";\r\nimport { contract, ensureContractIsDeployed } from \"../../../lib/blockchain\";\r\n\r\nexport const runtime = \"nodejs\";\r\n\r\nasync function getTableColumns(connection, tableName) {\r\n  const [rows] = await connection.execute(`SHOW COLUMNS FROM ${tableName}`);\r\n  return new Set(rows.map((row) => String(row.Field).toLowerCase()));\r\n}\r\n\r\nexport async function POST(request) {\r\n  let connection;\r\n\r\n  try {\r\n    await ensureContractIsDeployed();\r\n    const body = await request.json();\r\n    const { studentId } = body;\r\n\r\n    if (!studentId || !String(studentId).trim()) {\r\n      return NextResponse.json({ success: false, error: \"studentId is required\" }, { status: 400 });\r\n    }\r\n\r\n    const normalizedStudentId = String(studentId).trim();\r\n    const pool = await getPool();\r\n    connection = await pool.getConnection();\r\n    await connection.beginTransaction();\r\n\r\n    const [certRows] = await connection.execute(\r\n      `\r\n        SELECT id, is_revoked\r\n        FROM certificates\r\n        WHERE student_id = ?\r\n        ORDER BY id DESC\r\n        LIMIT 1\r\n      `,\r\n      [normalizedStudentId]\r\n    );\r\n\r\n    if (certRows.length === 0) {\r\n      await connection.rollback();\r\n      return NextResponse.json(\r\n        { success: false, error: \"Certificate does not exist for this student\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (Boolean(certRows[0].is_revoked)) {\r\n      await connection.rollback();\r\n      return NextResponse.json({ success: false, error: \"Certificate already revoked\" }, { status: 409 });\r\n    }\r\n\r\n    const tx = await contract.revokeRecord(normalizedStudentId);\r\n    const receipt = await tx.wait();\r\n\r\n    const certificateColumns = await getTableColumns(connection, \"certificates\");\r\n    const updateParts = [\"is_revoked = 1\"];\r\n    const updateParams = [];\r\n\r\n    if (certificateColumns.has(\"revoked_at\")) {\r\n      updateParts.push(\"revoked_at = NOW()\");\r\n    }\r\n\r\n    if (certificateColumns.has(\"revoke_tx_hash\")) {\r\n      updateParts.push(\"revoke_tx_hash = ?\");\r\n      updateParams.push(receipt.hash);\r\n    } else if (certificateColumns.has(\"blockchain_tx_hash\")) {\r\n      // Fallback for schemas that don't have a dedicated revoke tx hash column.\r\n      updateParts.push(\"blockchain_tx_hash = ?\");\r\n      updateParams.push(receipt.hash);\r\n    }\r\n\r\n    updateParams.push(certRows[0].id);\r\n\r\n    await connection.execute(\r\n      `\r\n        UPDATE certificates\r\n        SET ${updateParts.join(\", \")}\r\n        WHERE id = ?\r\n      `,\r\n      updateParams\r\n    );\r\n\r\n    await connection.commit();\r\n\r\n    return NextResponse.json(\r\n      {\r\n        success: true,\r\n        message: \"Certificate revoked successfully\",\r\n        studentId: normalizedStudentId,\r\n        blockchainTxHash: receipt.hash,\r\n      },\r\n      { status: 200 }\r\n    );\r\n  } catch (error) {\r\n    if (connection) {\r\n      try {\r\n        await connection.rollback();\r\n      } catch (rollbackError) {\r\n        console.error(\"Rollback failed:\", rollbackError);\r\n      }\r\n    }\r\n\r\n    console.error(\"Admin revoke error:\", error);\r\n    return NextResponse.json(\r\n      { success: false, error: error.shortMessage || error.message || \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  } finally {\r\n    if (connection) {\r\n      connection.release();\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAEO,MAAM,UAAU;AAEvB,eAAe,gBAAgB,UAAU,EAAE,SAAS;IAClD,MAAM,CAAC,KAAK,GAAG,MAAM,WAAW,OAAO,CAAC,CAAC,kBAAkB,EAAE,WAAW;IACxE,OAAO,IAAI,IAAI,KAAK,GAAG,CAAC,CAAC,MAAQ,OAAO,IAAI,KAAK,EAAE,WAAW;AAChE;AAEO,eAAe,KAAK,OAAO;IAChC,IAAI;IAEJ,IAAI;QACF,MAAM,IAAA,yNAAwB;QAC9B,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,SAAS,EAAE,GAAG;QAEtB,IAAI,CAAC,aAAa,CAAC,OAAO,WAAW,IAAI,IAAI;YAC3C,OAAO,mNAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC7F;QAEA,MAAM,sBAAsB,OAAO,WAAW,IAAI;QAClD,MAAM,OAAO,MAAM,IAAA,gMAAO;QAC1B,aAAa,MAAM,KAAK,aAAa;QACrC,MAAM,WAAW,gBAAgB;QAEjC,MAAM,CAAC,SAAS,GAAG,MAAM,WAAW,OAAO,CACzC,CAAC;;;;;;MAMD,CAAC,EACD;YAAC;SAAoB;QAGvB,IAAI,SAAS,MAAM,KAAK,GAAG;YACzB,MAAM,WAAW,QAAQ;YACzB,OAAO,mNAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;YAA8C,GACvE;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,QAAQ,QAAQ,CAAC,EAAE,CAAC,UAAU,GAAG;YACnC,MAAM,WAAW,QAAQ;YACzB,OAAO,mNAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAA8B,GAAG;gBAAE,QAAQ;YAAI;QACnG;QAEA,MAAM,KAAK,MAAM,yMAAQ,CAAC,YAAY,CAAC;QACvC,MAAM,UAAU,MAAM,GAAG,IAAI;QAE7B,MAAM,qBAAqB,MAAM,gBAAgB,YAAY;QAC7D,MAAM,cAAc;YAAC;SAAiB;QACtC,MAAM,eAAe,EAAE;QAEvB,IAAI,mBAAmB,GAAG,CAAC,eAAe;YACxC,YAAY,IAAI,CAAC;QACnB;QAEA,IAAI,mBAAmB,GAAG,CAAC,mBAAmB;YAC5C,YAAY,IAAI,CAAC;YACjB,aAAa,IAAI,CAAC,QAAQ,IAAI;QAChC,OAAO,IAAI,mBAAmB,GAAG,CAAC,uBAAuB;YACvD,0EAA0E;YAC1E,YAAY,IAAI,CAAC;YACjB,aAAa,IAAI,CAAC,QAAQ,IAAI;QAChC;QAEA,aAAa,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,EAAE;QAEhC,MAAM,WAAW,OAAO,CACtB,CAAC;;YAEK,EAAE,YAAY,IAAI,CAAC,MAAM;;MAE/B,CAAC,EACD;QAGF,MAAM,WAAW,MAAM;QAEvB,OAAO,mNAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,SAAS;YACT,WAAW;YACX,kBAAkB,QAAQ,IAAI;QAChC,GACA;YAAE,QAAQ;QAAI;IAElB,EAAE,OAAO,OAAO;QACd,IAAI,YAAY;YACd,IAAI;gBACF,MAAM,WAAW,QAAQ;YAC3B,EAAE,OAAO,eAAe;gBACtB,QAAQ,KAAK,CAAC,oBAAoB;YACpC;QACF;QAEA,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,mNAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO,MAAM,YAAY,IAAI,MAAM,OAAO,IAAI;QAAwB,GACxF;YAAE,QAAQ;QAAI;IAElB,SAAU;QACR,IAAI,YAAY;YACd,WAAW,OAAO;QACpB;IACF;AACF"}}]
}