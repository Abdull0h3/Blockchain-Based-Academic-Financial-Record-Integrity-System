module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/crypto [external] (crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}),
"[externals]/fs [external] (fs, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}),
"[externals]/path [external] (path, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[externals]/events [external] (events, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}),
"[externals]/util [external] (util, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}),
"[externals]/assert [external] (assert, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("assert", () => require("assert"));

module.exports = mod;
}),
"[externals]/buffer [external] (buffer, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}),
"[externals]/node:buffer [external] (node:buffer, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:buffer", () => require("node:buffer"));

module.exports = mod;
}),
"[externals]/process [external] (process, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("process", () => require("process"));

module.exports = mod;
}),
"[externals]/net [external] (net, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}),
"[externals]/tls [external] (tls, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}),
"[externals]/timers [external] (timers, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("timers", () => require("timers"));

module.exports = mod;
}),
"[externals]/string_decoder [external] (string_decoder, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("string_decoder", () => require("string_decoder"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[project]/Desktop/Fifth semester/blockchain/project/frontend/app/lib/db.js [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "executeQuery",
    ()=>executeQuery,
    "getPool",
    ()=>getPool,
    "pool",
    ()=>pool
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$mysql2$2f$promise$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Desktop/Fifth semester/blockchain/project/frontend/node_modules/mysql2/promise.js [app-route] (ecmascript)");
;
let pool;
function createPool() {
    const parsedPort = process.env.DB_PORT ? Number(process.env.DB_PORT) : 3306;
    return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$mysql2$2f$promise$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].createPool({
        host: process.env.DB_HOST,
        user: process.env.DB_USER,
        password: process.env.DB_PASSWORD,
        database: process.env.DB_NAME || "academic_system",
        waitForConnections: true,
        port: Number.isNaN(parsedPort) ? 3306 : parsedPort,
        connectionLimit: 10,
        queueLimit: 0
    });
}
async function getPool() {
    try {
        if (!pool) {
            pool = createPool();
        }
        // Lightweight health-check to fail fast if DB credentials are invalid.
        await pool.query("SELECT 1");
        return pool;
    } catch (error) {
        console.error("Database connection error:", error);
        throw new Error("Failed to connect to MySQL");
    }
}
async function executeQuery(sql, params = []) {
    try {
        const db = await getPool();
        const [result] = await db.execute(sql, params);
        return result;
    } catch (error) {
        console.error("Database query error:", error);
        throw new Error("Database query failed");
    }
}
;
}),
"[externals]/node:crypto [external] (node:crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:crypto", () => require("node:crypto"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[project]/Desktop/Fifth semester/blockchain/project/frontend/app/abi.json (json)", ((__turbopack_context__) => {

__turbopack_context__.v([{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"studentId","type":"string"},{"indexed":false,"internalType":"string","name":"documentHash","type":"string"}],"name":"RecordIssued","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"studentId","type":"string"}],"name":"RecordRevoked","type":"event"},{"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_studentId","type":"string"},{"internalType":"string","name":"_documentHash","type":"string"},{"internalType":"string","name":"_issuer","type":"string"}],"name":"issueRecord","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_studentId","type":"string"}],"name":"revokeRecord","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_studentId","type":"string"}],"name":"verifyRecord","outputs":[{"components":[{"internalType":"string","name":"studentId","type":"string"},{"internalType":"string","name":"documentHash","type":"string"},{"internalType":"string","name":"issuer","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isValid","type":"bool"}],"internalType":"struct AcademicRecords.Record","name":"","type":"tuple"}],"stateMutability":"view","type":"function"}]);}),
"[project]/Desktop/Fifth semester/blockchain/project/frontend/app/lib/blockchain.js [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "contract",
    ()=>contract,
    "ensureContractIsDeployed",
    ()=>ensureContractIsDeployed,
    "provider",
    ()=>provider,
    "wallet",
    ()=>wallet
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$ethers$2f$lib$2e$esm$2f$ethers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__ethers$3e$__ = __turbopack_context__.i("[project]/Desktop/Fifth semester/blockchain/project/frontend/node_modules/ethers/lib.esm/ethers.js [app-route] (ecmascript) <export * as ethers>");
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$app$2f$abi$2e$json__$28$json$29$__ = __turbopack_context__.i("[project]/Desktop/Fifth semester/blockchain/project/frontend/app/abi.json (json)");
;
;
function validateEnv() {
    const required = [
        "PRIVATE_KEY",
        "CONTRACT_ADDRESS"
    ];
    const missing = required.filter((key)=>!process.env[key]);
    if (missing.length > 0) {
        throw new Error(`Missing required environment variables: ${missing.join(", ")}`);
    }
}
validateEnv();
// Provider = read/write connection to the Ethereum JSON-RPC node.
// It talks to Hardhat local chain at http://127.0.0.1:8545.
const provider = new __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$ethers$2f$lib$2e$esm$2f$ethers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__ethers$3e$__["ethers"].JsonRpcProvider(process.env.RPC_URL || "http://127.0.0.1:8545");
// Wallet = backend signing identity. Every state-changing tx is signed with
// this private key before being broadcast. The key must stay server-side only.
const wallet = new __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$ethers$2f$lib$2e$esm$2f$ethers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__ethers$3e$__["ethers"].Wallet(process.env.PRIVATE_KEY, provider);
// Contract instance bound to the signing wallet.
// Digital signature flow:
// 1) API route calls a write method (e.g., issueRecord).
// 2) ethers prepares transaction data.
// 3) wallet signs tx with PRIVATE_KEY.
// 4) signed tx is sent to chain and validated by nodes.
const contract = new __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$ethers$2f$lib$2e$esm$2f$ethers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__ethers$3e$__["ethers"].Contract(process.env.CONTRACT_ADDRESS, __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$app$2f$abi$2e$json__$28$json$29$__["default"], wallet);
let contractCodeValidated = false;
async function ensureContractIsDeployed() {
    if (contractCodeValidated) {
        return;
    }
    const code = await provider.getCode(process.env.CONTRACT_ADDRESS);
    if (!code || code === "0x") {
        throw new Error("Invalid CONTRACT_ADDRESS: no contract bytecode found. Set CONTRACT_ADDRESS to the deployed AcademicRecords contract address.");
    }
    contractCodeValidated = true;
}
;
}),
"[project]/Desktop/Fifth semester/blockchain/project/frontend/app/api/admin/issue-certificate/route.js [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "POST",
    ()=>POST,
    "runtime",
    ()=>runtime
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Desktop/Fifth semester/blockchain/project/frontend/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/crypto [external] (crypto, cjs)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/fs [external] (fs, cjs)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/path [external] (path, cjs)");
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$pdfkit$2f$js$2f$pdfkit$2e$es$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Desktop/Fifth semester/blockchain/project/frontend/node_modules/pdfkit/js/pdfkit.es.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$qrcode$2f$lib$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Desktop/Fifth semester/blockchain/project/frontend/node_modules/qrcode/lib/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$app$2f$lib$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Desktop/Fifth semester/blockchain/project/frontend/app/lib/db.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$app$2f$lib$2f$blockchain$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Desktop/Fifth semester/blockchain/project/frontend/app/lib/blockchain.js [app-route] (ecmascript)");
;
;
;
;
;
;
;
;
const runtime = "nodejs";
async function getTableColumns(connection, tableName) {
    const [rows] = await connection.execute(`SHOW COLUMNS FROM ${tableName}`);
    return new Set(rows.map((row)=>String(row.Field).toLowerCase()));
}
function normalizeStatus(value) {
    return String(value || "").trim().toLowerCase();
}
function gradeToPoint(grade) {
    const map = {
        "A+": 4.0,
        A: 4.0,
        "A-": 3.7,
        "B+": 3.3,
        B: 3.0,
        "B-": 2.7,
        "C+": 2.3,
        C: 2.0,
        "C-": 1.7,
        "D+": 1.3,
        D: 1.0,
        F: 0.0
    };
    return map[String(grade || "").toUpperCase()];
}
function calculateCgpa(courses) {
    let totalWeightedPoints = 0;
    let totalCredits = 0;
    for (const course of courses){
        const creditHours = Number(course.credit_hours ?? 0);
        const gradePointFromRow = Number(course.grade_point);
        const derivedGradePoint = Number.isFinite(gradePointFromRow) ? gradePointFromRow : gradeToPoint(course.grade);
        if (creditHours > 0 && Number.isFinite(derivedGradePoint)) {
            totalWeightedPoints += derivedGradePoint * creditHours;
            totalCredits += creditHours;
        }
    }
    if (totalCredits === 0) {
        return null;
    }
    return Number((totalWeightedPoints / totalCredits).toFixed(2));
}
function resolvePdfFontPath() {
    const candidates = [
        process.env.PDF_FONT_PATH,
        "C:\\Windows\\Fonts\\arial.ttf",
        "C:\\Windows\\Fonts\\calibri.ttf",
        "/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf",
        "/usr/share/fonts/truetype/liberation/LiberationSans-Regular.ttf"
    ].filter(Boolean);
    return candidates.find((candidate)=>__TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__["default"].existsSync(candidate)) || null;
}
async function writePdf({ studentId, fullName, program, cgpa, graduationYear }) {
    const safeStudentId = String(studentId).replace(/[^a-zA-Z0-9_-]/g, "_");
    const certificatesDir = __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__["default"].join(process.cwd(), "public", "uploads", "certificates");
    const fileName = `${safeStudentId}.pdf`;
    const absolutePath = __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__["default"].join(certificatesDir, fileName);
    const publicPath = `/uploads/certificates/${fileName}`;
    await __TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__["default"].promises.mkdir(certificatesDir, {
        recursive: true
    });
    const verificationUrl = `http://localhost:3000/verify/${encodeURIComponent(studentId)}`;
    const qrDataUrl = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$qrcode$2f$lib$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].toDataURL(verificationUrl);
    const qrBuffer = Buffer.from(qrDataUrl.split(",")[1], "base64");
    const fontPath = resolvePdfFontPath();
    await new Promise((resolve, reject)=>{
        // Use a real TTF font file to avoid runtime lookup issues for bundled AFM files.
        const doc = new __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$pdfkit$2f$js$2f$pdfkit$2e$es$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"]({
            size: "A4",
            margin: 50,
            font: fontPath || undefined
        });
        const stream = __TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__["default"].createWriteStream(absolutePath);
        stream.on("finish", resolve);
        stream.on("error", reject);
        doc.on("error", reject);
        doc.pipe(stream);
        doc.fontSize(24).text("University Academic Certificate", {
            align: "center"
        });
        doc.moveDown(1.5);
        doc.fontSize(14).text(`Student Name: ${fullName}`);
        doc.text(`Student ID: ${studentId}`);
        doc.text(`Program: ${program}`);
        doc.text(`CGPA: ${cgpa.toFixed(2)}`);
        doc.text(`Graduation Year: ${graduationYear}`);
        doc.moveDown(1.5);
        doc.fontSize(11).text("Scan QR to verify certificate:", {
            align: "left"
        });
        doc.image(qrBuffer, {
            fit: [
                120,
                120
            ]
        });
        doc.moveDown();
        doc.fontSize(10).fillColor("gray").text(verificationUrl);
        doc.end();
    });
    return publicPath;
}
async function isAlreadyIssuedOnChain(studentId) {
    try {
        const record = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$app$2f$lib$2f$blockchain$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["contract"].verifyRecord(studentId);
        return Boolean(record?.timestamp && record.timestamp.toString() !== "0");
    } catch (_error) {
        // verifyRecord reverts when record does not exist
        return false;
    }
}
async function POST(request) {
    let connection;
    try {
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$app$2f$lib$2f$blockchain$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ensureContractIsDeployed"])();
        const body = await request.json();
        const { studentId } = body;
        if (!studentId || !String(studentId).trim()) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: "studentId is required"
            }, {
                status: 400
            });
        }
        const normalizedStudentId = String(studentId).trim();
        const pool = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$app$2f$lib$2f$db$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getPool"])();
        connection = await pool.getConnection();
        await connection.beginTransaction();
        const [students] = await connection.execute(`
        SELECT
          s.student_id,
          s.full_name,
          s.program,
          s.graduation_year,
          s.status,
          COALESCE(fr.clearance_approved, 0) AS financial_clearance,
          COALESCE(GROUP_CONCAT(a.activity_name ORDER BY a.activity_name SEPARATOR ', '), '') AS activities_summary
        FROM students s
        LEFT JOIN financial_records fr ON fr.student_id = s.student_id
        LEFT JOIN student_activities sa ON sa.student_id = s.student_id
        LEFT JOIN activities a ON a.id = sa.activity_id
        WHERE s.student_id = ?
        GROUP BY
          s.student_id, s.full_name, s.program, s.graduation_year, s.status, fr.clearance_approved
        LIMIT 1
      `, [
            normalizedStudentId
        ]);
        if (students.length === 0) {
            await connection.rollback();
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: "Student not found"
            }, {
                status: 404
            });
        }
        const student = students[0];
        const status = normalizeStatus(student.status);
        if (status !== "graduated") {
            await connection.rollback();
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: "Student is not eligible: status must be graduated"
            }, {
                status: 400
            });
        }
        if (!Boolean(student.financial_clearance)) {
            await connection.rollback();
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: "Financial clearance is not approved"
            }, {
                status: 400
            });
        }
        const [existingCertificates] = await connection.execute(`
        SELECT id, is_revoked
        FROM certificates
        WHERE student_id = ?
        ORDER BY id DESC
        LIMIT 1
      `, [
            normalizedStudentId
        ]);
        if (existingCertificates.length > 0) {
            const existing = existingCertificates[0];
            if (Boolean(existing.is_revoked)) {
                await connection.rollback();
                return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    success: false,
                    error: "Cannot issue certificate again for a revoked record"
                }, {
                    status: 400
                });
            }
            await connection.rollback();
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: "Certificate already issued for this student"
            }, {
                status: 409
            });
        }
        const [courses] = await connection.execute(`
        SELECT sc.grade, c.credit_hours
        FROM student_courses sc
        INNER JOIN courses c ON c.course_code = sc.course_code
        WHERE sc.student_id = ?
      `, [
            normalizedStudentId
        ]);
        const cgpa = calculateCgpa(courses);
        if (cgpa === null) {
            await connection.rollback();
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: "Unable to calculate CGPA from student_courses"
            }, {
                status: 400
            });
        }
        const graduationYear = Number(student.graduation_year);
        const graduationDate = Number.isFinite(graduationYear) ? `${graduationYear}-06-30` : new Date().toISOString().slice(0, 10);
        const academicString = `${normalizedStudentId}|${student.full_name}|${student.program}|${cgpa.toFixed(2)}|${student.graduation_year}`;
        const documentHash = (0, __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__["createHash"])("sha256").update(academicString).digest("hex");
        const onChainExists = await isAlreadyIssuedOnChain(normalizedStudentId);
        if (onChainExists) {
            await connection.rollback();
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: "Certificate already exists on blockchain for this student"
            }, {
                status: 409
            });
        }
        const tx = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$app$2f$lib$2f$blockchain$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["contract"].issueRecord(normalizedStudentId, documentHash, "University");
        const receipt = await tx.wait();
        const pdfPath = await writePdf({
            studentId: normalizedStudentId,
            fullName: student.full_name,
            program: student.program,
            cgpa,
            graduationYear: student.graduation_year
        });
        const certificateColumns = await getTableColumns(connection, "certificates");
        const insertColumns = [
            "student_id"
        ];
        const insertParams = [
            normalizedStudentId
        ];
        const valueTokens = [
            "?"
        ];
        // Snapshot issuance-time academic fields to support tamper detection later.
        if (certificateColumns.has("full_name")) {
            insertColumns.push("full_name");
            valueTokens.push("?");
            insertParams.push(student.full_name);
        }
        if (certificateColumns.has("program")) {
            insertColumns.push("program");
            valueTokens.push("?");
            insertParams.push(student.program);
        }
        insertColumns.push("cgpa");
        valueTokens.push("?");
        insertParams.push(cgpa);
        insertColumns.push("graduation_date");
        valueTokens.push("?");
        insertParams.push(graduationDate);
        insertColumns.push("document_hash");
        valueTokens.push("?");
        insertParams.push(documentHash);
        insertColumns.push("contract_address");
        valueTokens.push("?");
        insertParams.push(process.env.CONTRACT_ADDRESS);
        insertColumns.push("issued_at");
        valueTokens.push("NOW()");
        insertColumns.push("blockchain_tx_hash");
        valueTokens.push("?");
        insertParams.push(receipt.hash);
        insertColumns.push("is_revoked");
        valueTokens.push("0");
        // Optional column for storing generated certificate path if the schema has it.
        if (certificateColumns.has("pdf_path")) {
            insertColumns.push("pdf_path");
            valueTokens.push("?");
            insertParams.push(pdfPath);
        }
        const [result] = await connection.execute(`
        INSERT INTO certificates (${insertColumns.join(", ")})
        VALUES (${valueTokens.join(", ")})
      `, insertParams);
        await connection.commit();
        return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: true,
            message: "Certificate issued successfully",
            certificateId: result.insertId,
            studentId: normalizedStudentId,
            cgpa,
            documentHash,
            blockchainTxHash: receipt.hash,
            pdfPath,
            activitiesSummary: student.activities_summary
        }, {
            status: 201
        });
    } catch (error) {
        if (connection) {
            try {
                await connection.rollback();
            } catch (rollbackError) {
                console.error("Rollback failed:", rollbackError);
            }
        }
        console.error("Admin issue-certificate error:", error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$Fifth__semester$2f$blockchain$2f$project$2f$frontend$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: false,
            error: error.shortMessage || error.message || "Internal server error"
        }, {
            status: 500
        });
    } finally{
        if (connection) {
            connection.release();
        }
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__bcef4be7._.js.map